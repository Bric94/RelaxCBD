{% extends 'base.html.twig' %}

{% block body %}
	<h1>Mon Panier</h1>

	{% if cartItems is empty %}
		<p>Votre panier est vide.</p>
	{% else %}
		<table class="table table-hover">
			<thead class="table-light">
				<tr>
					<th>Produit</th>
					<th>Grammage</th>
					<th>QuantitÃ©</th>
					<th>Prix unitaire</th>
					<th>RÃ©duction</th>
					<th>Sous-total</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				{% for item in cartItems %}
					<tr>
						<!-- Nom du produit -->
						<td>
							<strong>{{ item.product.name }}</strong>
						</td>

						<!-- Grammage -->
						<td>
							{% if item.weight %}
								{{ item.quantity }}
								{% if 'g' not in item.weight %}
									g
								{% endif %}
							{% else %}
								{{ item.quantity }}
							{% endif %}
						</td>

						<!-- QuantitÃ© -->
						<td>{{ item.quantity }}</td>

						<!-- Prix unitaire -->
						<td>
							{% if item.discount > 0 %}
								<span class="text-danger">
									<s>{{ item.original_price|number_format(2, ',', ' ') }}
										â‚¬</s>
								</span>
								<br>
								<strong class="text-success">{{ item.price|number_format(2, ',', ' ') }}
									â‚¬</strong>
							{% else %}
								{{ item.price|number_format(2, ',', ' ') }}
								â‚¬
							{% endif %}
						</td>

						<!-- DÃ©tails des prix et rÃ©ductions -->
						<td>
							{% if item.weight %}
								{% set priceByWeight = item.product.getPriceByWeight() %}
								{% set price1g = priceByWeight['1'] ?? item.product.getPrice() %}
								{% set selectedPrice = priceByWeight[item.weight] ?? item.original_price %}
								{% set totalBasePrice = price1g * item.quantity %}
								{% set totalFinalPrice = selectedPrice * item.quantity %}
								{% set totalDiscount = totalBasePrice - totalFinalPrice %}

								{% if totalDiscount > 0 %}
									<ul class="list-unstyled">
										<li>ðŸ’°
											<strong>Prix de base :</strong>
											{{ totalBasePrice|number_format(2, ',', ' ') }}
											â‚¬</li>
										<li>ðŸŽ¯
											<strong>Prix rÃ©duit :</strong>
											<span class="text-primary">{{ totalFinalPrice|number_format(2, ',', ' ') }}
												â‚¬</span>
										</li>
										<li>ðŸ“‰
											<strong>Total remise :</strong>
											<span class="text-danger">-{{ totalDiscount|number_format(2, ',', ' ') }}
												â‚¬</span>
										</li>
									</ul>
								{% else %}
									<span class="badge bg-secondary">Aucune remise</span>
								{% endif %}
							{% else %}
								<span class="badge bg-secondary">Aucune remise</span>
							{% endif %}
						</td>

						<!-- Sous-total -->
						<td>
							<strong>{{ (item.price * item.quantity)|number_format(2, ',', ' ') }}
								â‚¬</strong>
						</td>

						<!-- Actions -->
						<td>
							<a href="{{ path('cart_remove', { id: item.product.id, weight: item.weight }) }}" class="btn btn-danger btn-sm">
								Supprimer
							</a>
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>

		<!-- Total gÃ©nÃ©ral -->
		<h3 class="text-end mt-3">
			Total :
			<strong>{{ total|number_format(2, ',', ' ') }}
				â‚¬</strong>
		</h3>

		<!-- Boutons d'action -->
		<div class="d-flex justify-content-between mt-3">
			<a href="{{ path('cart_clear') }}" class="btn btn-warning">Vider le panier</a>
			<a href="{{ path('order_checkout') }}" class="btn btn-success">Commander</a>
		</div>
	{% endif %}
{% endblock %}
