{# templates/product/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Nos Produits - Relax CBD Shop
{% endblock %}

{# permet de cibler cette page en CSS #}
{% block body_class %}page-product
{% endblock %}

{% block body %}
	<section class="products-container">
		<h1 class="section-title">DÉCOUVREZ NOS PRODUITS</h1>

		{# Barre de recherche et filtres #}
		<div class="filter-container">
			<form method="GET" action="{{ path('product_index') }}" class="filter-bar">
				<input type="text" name="q" class="search-input" placeholder="Rechercher..." value="{{ app.request.get('q') }}">

				<select name="category" id="category" class="filter-select">
					<option value="">Catégories</option>
					{% for category in categories %}
						<option value="{{ category.id }}" {% if app.request.get('category') == category.id %} selected {% endif %}>
							{{ category.name }}
						</option>
					{% endfor %}
				</select>

				<select name="sort" id="sort" class="filter-select">
					<option value="">Trier par</option>
					<option value="price_asc" {% if app.request.get('sort') == 'price_asc' %} selected {% endif %}>Prix croissant</option>
					<option value="price_desc" {% if app.request.get('sort') == 'price_desc' %} selected {% endif %}>Prix décroissant</option>
					<option value="newest" {% if app.request.get('sort') == 'newest' %} selected {% endif %}>Nouveautés</option>
				</select>

				<button type="submit" class="btn-small-filter">Appliquer</button>
			</form>
		</div>

		{# Grille des produits #}
		<div class="product-grid">
			{% for product in products %}
				<div class="product-card">
					<div class="product-image">
						<img src="{{ asset('uploads/products/' ~ product.image) }}" alt="{{ product.name }}">
					</div>

					<div class="product-details">
						<h2 class="product-title">{{ product.name }}</h2>
						<p class="product-price">
							{% if product.isWeightBased and product.priceByWeight is not empty %}
								À partir de<br>
								{% set firstWeight = product.priceByWeight|keys|last %}
								{{ product.calculateDiscountedPrice(firstWeight)|number_format(2, ',', ' ') }}
								€/g
							{% else %}
								{{ product.price|number_format(2, ',', ' ') }}
								€
							{% endif %}
						</p>

						<div class="product-actions">
							<form
								method="post" action="{{ path('cart_add', { id: product.id }) }}" class="product-form js-add-to-cart">
								{# Sélecteur de poids ou quantité #}
								{% if product.isWeightBased and product.getPriceByWeight() is not empty %}
									<select name="selectedWeight" id="selectedWeight_{{ product.id }}" class="weight-select" required>
										{% for weight, price in product.getPriceByWeight() %}
											<option value="{{ weight }}"> 
												{{ weight }}
												g -
												{{ price|number_format(2, ',', ' ') }}
												€/g
											</option>
										{% endfor %}
									</select>
								{% else %}
									<input type="number" id="quantity_{{ product.id }}" name="quantity" value="1" min="1" max="{{ product.stock }}" class="quantity-input">
								{% endif %}

								<div class="actions">
									<button type="submit" class="btn-add">Ajouter au panier</button>
									<a href="{{ path('product_show', { id: product.id }) }}" class="btn-info" aria-label="Plus d'informations">
										<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
											<circle cx="12" cy="12" r="10"/>
											<circle cx="12" cy="8" r="1"/>
											<line x1="12" y1="11" x2="12" y2="16"/>
										</svg>
									</a>
								</div>
							</form>
						</div>
					</div>
				</div>
			{% else %}
				<p class="no-products">Aucun produit disponible.</p>
			{% endfor %}
		</div>

		<div class="cart-popup" id="js-cart-popup">
			<div class="cart-popup__backdrop"></div>
			<div class="cart-popup__dialog">
				<p id="js-cart-popup-message"></p>
				<div class="cart-popup__actions">
					<button class="btn-secondary" id="js-cart-popup-continue">Continuer mes achats</button>
					<button class="btn-primary" id="js-cart-popup-view">Voir mon panier</button>
				</div>
			</div>
		</div>

	</section>
{% endblock %}
